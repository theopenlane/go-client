env:
  GOCACHE: $HOME/.cache/go-build
  GOMODCACHE: $HOME/.cache/go/pkg/mod
  GOLANGCI_LINT_CACHE: $HOME/.cache/golangci-lint

secrets:
  - GITHUB_TOKEN
  - APOLLO_KEY
  - GITHUB_SSH_PRIVATE_KEY

steps:
  - label: ":graphql: generate"
    key: "generate"
    if: build.branch != "fix-safety-in-commit"
    agents:
      queue: $LARGE_RUNNER_QUEUE
      size: $RUNNER_LARGE
      location: "NYC"
    cancel_on_build_failing: true
    plugins:
      - docker#v5.13.0:
          image: "ghcr.io/theopenlane/build-image:latest"
          always_pull: true
          propagate-environment: true
          environment:
            - "APOLLO_KEY"
            - "GITHUB_TOKEN"
      - pr-commenter#v0.3.0:
          message: "Generated client changes have been pushed to the the PR branch. Please review the changes."
          secret-name: GITHUB_TOKEN
    command: |
      #!/bin/bash
      set -e
      set -o pipefail

      echo "--- running go generate"
      task generate
      EXIT_CODE=$?

      if [ "$EXIT_CODE" -ne 0 ]; then
        echo "task generate failed with exit code $EXIT_CODE"
        exit $EXIT_CODE
      fi

      echo "--- configuring git user"
      git config user.name "theopenlane-bender"
      git config user.email "theopenlane-bender@users.noreply.github.com"

      echo "--- checking for changes"
      if git diff --quiet; then
        echo "No changes from go generate; nothing to commit."
        exit 0
      fi

      echo "--- committing changes"
      git status
      git checkout "${BUILDKITE_BRANCH}"
      git add graphclient/*

      # commit changes
      git commit -m "chore: run go generate"

      echo "--- pushing to origin ${BUILDKITE_BRANCH}"
      git push "https://x-access-token:$${GITHUB_TOKEN}@github.com/theopenlane/go-client.git" "HEAD:${BUILDKITE_BRANCH}"

  - label: ":graphql: generate"
    key: "generate-main"
    if: build.branch == "fix-safety-in-commit"
    agents:
      queue: $LARGE_RUNNER_QUEUE
      size: $RUNNER_LARGE
      location: "NYC"
    cancel_on_build_failing: true
    plugins:
      - docker#v5.13.0:
          image: "ghcr.io/theopenlane/build-image:latest"
          always_pull: true
          propagate-environment: true
          environment:
            - "APOLLO_KEY"
            - "GITHUB_TOKEN"
            - "BUILDKITE_AGENT_ACCESS_TOKEN"
    command: |
      #!/bin/bash
      set -e
      set -o pipefail

      echo "--- running go generate"
      task generate
      EXIT_CODE=$?

      if [ "$EXIT_CODE" -ne 0 ]; then
        echo "task generate failed with exit code $EXIT_CODE"
        exit $EXIT_CODE
      fi

      echo "--- configuring git user"
      git config user.name "theopenlane-bender"
      git config user.email "theopenlane-bender@users.noreply.github.com"

      echo "--- checking for changes"
      if git diff --quiet; then
        echo "No changes from go generate; nothing to commit."
        exit 0
      fi

      echo "--- committing changes"
      branchName="chore/go-generate-$(date +%s)"
      git status
      git checkout -b "$$branchName"
      git add graphclient/*

      # commit changes
      git commit -m "chore: run go generate"

      echo "--- pushing to origin chore/go-generate"
      git push "https://x-access-token:$${GITHUB_TOKEN}@github.com/theopenlane/go-client.git" "HEAD:$$branchName"

      echo "Changes found, creating pull request..."
      cat <<EOF | buildkite-agent pipeline upload
      steps:
        - label: ":github: pr generated changes
          key: "create_pr"
          command: "echo 'Creating PR...'"
          plugins:
            - envato/github-pull-request#v0.4.0:
                title: "chore: generated client changes"
                head: "$$branchName"
      EOF

  - label: ":golangci-lint: lint :lint-roller:"
    if_changed:
      - "**.go"
      - .golangci.yaml
    agents:
      queue: $LARGE_RUNNER_QUEUE
      size: $RUNNER_LARGE
    cancel_on_build_failing: true
    key: "lint"
    plugins:
      - docker#v5.13.0:
          image: "ghcr.io/theopenlane/build-image:latest"
          command: ["task", "go:lint:ci"]
          always_pull: true
          propagate-environment: true
          volumes:
            - $GOCACHE:$GOCACHE
            - $GOMODCACHE:$GOMODCACHE
            - $GOLANGCI_LINT_CACHE:$GOLANGCI_LINT_CACHE
          environment:
            - "GOTOOLCHAIN=auto"
  - label: ":golang: go test"
    key: "go_test"
    if_changed:
      - "**.go"
      - "go.mod"
    plugins:
      - docker#v5.13.0:
          image: "ghcr.io/theopenlane/build-image:latest"
          always-pull: true
          command: ["task", "go:test"]
